<div class="tachikoma-container">
    <div class="scanlines"></div>

    <!-- Agent Selection Dialog -->
    <div class="agent-selector-overlay" *ngIf="showAgentSelector()" (click)="cancelNewChat()">
        <div class="agent-selector-dialog" (click)="$event.stopPropagation()">
            <div class="dialog-header">
                <h2>SELECT PARTICIPATING AGENTS</h2>
                <button mat-icon-button (click)="cancelNewChat()" class="close-btn">
                    <mat-icon>close</mat-icon>
                </button>
            </div>

            <div class="dialog-actions">
                <button mat-stroked-button (click)="selectAllAgents()" class="action-btn">
                    Select All
                </button>
                <button mat-stroked-button (click)="deselectAllAgents()" class="action-btn">
                    Clear All
                </button>
            </div>

            <div class="agent-list">
                <div *ngFor="let agent of availableAgents" class="agent-item"
                    [class.selected]="selectedAgentIds().has(agent.id)" (click)="toggleAgentSelection(agent.id)">
                    <div class="agent-checkbox">
                        <mat-icon *ngIf="selectedAgentIds().has(agent.id)">check_box</mat-icon>
                        <mat-icon *ngIf="!selectedAgentIds().has(agent.id)">check_box_outline_blank</mat-icon>
                    </div>
                    <div class="agent-info">
                        <div class="agent-name" [style.color]="agent.hex">{{ agent.name }}</div>
                        <div class="agent-role">{{ agent.role === 'moderator' ? 'MODERATOR' : 'CHATTER' }}</div>
                    </div>
                    <div class="agent-color-badge" [style.background-color]="agent.hex"></div>
                </div>

                <div *ngIf="availableAgents.length === 0" class="empty-agents">
                    No agents configured. Please create agents in the Tachikomas page.
                </div>
            </div>

            <div class="dialog-footer">
                <button mat-raised-button color="primary" (click)="createNewChat()" class="create-btn">
                    START CHAT ({{ selectedAgentIds().size }} selected)
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="chat-header">
        <div class="header-left">
            <div class="version-badge">V2.5</div>
            <div>
                <h1 class="protocol-title glitch">TACHIKOMA PROTOCOL</h1>
                <div class="sync-status">
                    <span class="status-dot"></span>
                    SYNC MODE: SECURE-LINK
                </div>
            </div>
        </div>

        <!-- Desktop: Always show initialization form -->
        <div class="header-right desktop-only">
            <button (click)="showNewChatDialog()" class="new-chat-btn" matTooltip="New Chat">
                <mat-icon>add</mat-icon>
            </button>
            <input type="password" [(ngModel)]="apiKey" placeholder="Enter Gemini API Key" class="api-input" />
            <button (click)="saveKey()" class="init-btn">INITIALIZE</button>
        </div>
    </header>

    <!-- Mobile: Conditional display -->
    <div class="mobile-control-panel mobile-only">
        <!-- Show initialization form if not initialized -->
        <div *ngIf="!isInitialized" class="mobile-init-section">
            <input type="password" [(ngModel)]="apiKey" placeholder="Enter Gemini API Key" class="api-input-mobile" />
            <button (click)="saveKey()" class="init-btn-mobile">INITIALIZE</button>
        </div>

        <!-- Show status panel if initialized -->
        <div *ngIf="isInitialized" class="mobile-status-section">
            <h3 class="panel-title-mobile">NEURAL ACTIVITY</h3>
            <div class="agent-status-mobile" *ngFor="let agent of agents">
                <div class="status-row-mobile">
                    <span class="agent-label" [style.color]="agent.hex">{{agent.name}}</span>
                    <span class="status-text">{{agent.status === 'thinking' ? 'PROCESSING...' :
                        'IDLE'}}</span>
                </div>
                <div class="progress-track-mobile">
                    <div class="progress-bar" [style.background-color]="agent.hex"
                        [style.width]="agent.status === 'thinking' ? '100%' : '0%'"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Drawer Container for Chat History -->
    <mat-drawer-container class="chat-drawer-container" autosize>
        <mat-drawer-content>
            <!-- Main Chat Area -->
            <main class="chat-main">
                <!-- Chat history toggle button -->
                <button mat-icon-button class="history-toggle-btn" (click)="toggleHistoryDrawer()"
                    matTooltip="Chat History">
                    <mat-icon>history</mat-icon>
                </button>
                <!-- Chat Feed -->
                <div class="chat-feed" #chatFeed (scroll)="onScroll()">
                    <!-- Intro Message -->
                    <div class="intro-message">
                        <p>NEURAL LINK ESTABLISHED.</p>
                        <p>AGENTS: LOGIKOMA, GHOST-1, MODERATOR</p>
                        <p class="sub-intro">INITIATIVE IS RANDOMIZED PER QUERY.</p>
                    </div>

                    <!-- Messages -->
                    <div *ngFor="let msg of messages" class="message-wrapper"
                        [ngClass]="{'user-msg': msg.isUser, 'agent-msg': !msg.isUser}">

                        <!-- User Message -->
                        <div *ngIf="msg.isUser" class="user-bubble">
                            <div class="msg-header">USER // AUTHENTICATED</div>
                            <div class="msg-content" [innerHTML]="msg.html"></div>
                        </div>

                        <!-- Agent Message -->
                        <div *ngIf="!msg.isUser" class="agent-card" [ngClass]="msg.agentId || ''"
                            [style.border-color]="getAgentColor(msg.agentId)"
                            [style.background]="getAgentColor(msg.agentId) + '0D'">
                            <div class="agent-header">
                                <span class="agent-icon">
                                    <ng-container [ngSwitch]="msg.agentId">
                                        <span *ngSwitchCase="'logikoma'">◈</span>
                                        <span *ngSwitchCase="'ghost'">❖</span>
                                        <span *ngSwitchCase="'moderator'">⬢</span>
                                        <span *ngSwitchDefault>●</span>
                                    </ng-container>
                                </span>
                                <span class="agent-name"
                                    [style.color]="getAgentColor(msg.agentId)">{{msg.sender}}</span>
                            </div>
                            <div class="msg-content" [innerHTML]="msg.html"></div>
                        </div>
                    </div>

                    <!-- Loading Indicator (Generic for now, could be per agent) -->
                    <div *ngIf="isProcessing" class="processing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>

                <!-- Right Panel: Active Status -->
                <div class="status-panel">
                    <h3 class="panel-title">NEURAL ACTIVITY</h3>

                    <div class="agent-status" *ngFor="let agent of agents">
                        <div class="status-row">
                            <span class="agent-label" [style.color]="agent.hex">{{agent.name}}</span>
                            <span class="status-text">{{agent.status === 'thinking' ? 'PROCESSING...' :
                                'IDLE'}}</span>
                        </div>
                        <div class="progress-track">
                            <div class="progress-bar" [style.background-color]="agent.hex"
                                [style.width]="agent.status === 'thinking' ? '100%' : '0%'"></div>
                        </div>
                    </div>

                    <div class="debug-stack">
                        <p>DEBUG STACK:</p>
                        <div class="memory-log">
                            // System Ready<br>
                            <ng-container *ngFor="let msg of messages">
                                > PACKET RECEIVED: {{msg.timestamp}}<br>
                            </ng-container>
                        </div>
                    </div>
                </div>
            </main>
        </mat-drawer-content>

        <!-- Right Drawer for Chat History -->
        <mat-drawer #historyDrawer mode="over" position="end" [opened]="historyDrawerOpened()">
            <div class="chat-history-drawer">
                <div class="drawer-header">
                    <h3>CHAT HISTORY</h3>
                    <div class="drawer-actions">
                        <button mat-icon-button class="new-chat-btn" (click)="showNewChatDialog()"
                            matTooltip="New Chat">
                            <mat-icon>add</mat-icon>
                        </button>
                        <button mat-icon-button (click)="toggleHistoryDrawer()" matTooltip="Close">
                            <mat-icon>close</mat-icon>
                        </button>
                    </div>
                </div>
                <div class="chat-list">
                    <div *ngFor="let session of getChatSessions()" class="chat-item"
                        [class.active]="session.id === getCurrentChatId()" (click)="switchChat(session.id)">
                        <div class="chat-item-header">
                            <span class="chat-title">{{ session.title }}</span>
                            <button class="delete-chat-btn" (click)="deleteChat(session.id); $event.stopPropagation()"
                                matTooltip="Delete">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </div>
                        <div class="chat-meta">
                            <span class="chat-date">{{ session.updatedAt | date:'short' }}</span>
                            <span class="chat-count">{{ session.messages.length }} msgs</span>
                        </div>
                    </div>

                    <div *ngIf="getChatSessions().length === 0" class="empty-state">
                        No saved chats yet
                    </div>
                </div>
            </div>
        </mat-drawer>
    </mat-drawer-container>

    <!-- File Upload Area -->
    <div class="file-context-bar" *ngIf="hasUploadedFiles">
        <div class="file-context-header">
            <span class="file-context-label">
                <mat-icon>attach_file</mat-icon>
                SHARED CONTEXT ({{ uploadedFiles().length }} file(s))
            </span>
            <button mat-icon-button (click)="clearAllFiles()" matTooltip="Clear all files" class="clear-all-btn">
                <mat-icon>clear_all</mat-icon>
            </button>
        </div>
        <div class="file-chips">
            <div *ngFor="let file of uploadedFiles(); let i = index" class="file-chip">
                <mat-icon class="file-icon">description</mat-icon>
                <span class="file-name">{{ file.name }}</span>
                <button mat-icon-button (click)="removeFile(i)" class="remove-file-btn">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <footer class="chat-footer">
        <div class="input-wrapper">
            <input #fileInput type="file" multiple hidden (change)="onFileSelected($event)"
                accept=".txt,.md,.json,.csv,.xml,.log,text/*">
            <button mat-icon-button (click)="fileInput.click()" class="attach-btn"
                matTooltip="Upload file(s) for shared context" [disabled]="isUploadingFile()">
                <mat-icon *ngIf="!isUploadingFile()">attach_file</mat-icon>
                <mat-icon *ngIf="isUploadingFile()" class="spinning">sync</mat-icon>
            </button>
            <input type="text" [(ngModel)]="userInput" (keydown.enter)="triggerProtocol()" class="chat-input"
                placeholder="Send packet to the net...">
            <button (click)="triggerProtocol()" class="send-btn">SEND</button>
        </div>
    </footer>
</div>